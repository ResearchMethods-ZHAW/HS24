{
  "hash": "073cffe1448312ea71c991eda5f31add",
  "result": {
    "engine": "knitr",
    "markdown": "---\nlesson: Statistik 6\nknitr:\n  opts_chunk: \n    collapse: false\nmusterloesung: true\n---\n\n\n\n# Statistik 6: Übung\n\n**Datensatz *novanimal.csv***\n\n### Hintergrund Daten\n\nIm Forschungsprojekt NOVANIMAL wird u.a. der Frage nachgegangen, was es braucht, damit Menschen freiwillig weniger tierische Produkte konsumieren? Ein interessanter Ansatzpunkt ist die Ausser-Haus-Verpflegung. Gemäss der ersten in den Jahren 2014/2015 durchgeführten nationalen Ernährungserhebung menuCH essen 70 % der Bevölkerung zwischen 18 und 75 Jahren am Mittag auswärts [@bochud2017]. Daher rückt die Gastronomie als zentraler Akteur einer innovativen und nachhaltigen Ernährungswirtschaft ins Blickfeld. Welche Innovationen in der Gastronomie könnten dazu beitragen, den Pro-Kopf-Verbrauch an tierischen Nahrungsmitteln zu senken?\n\nDazu wurde u.a. ein Experiment in zwei Hochschulmensen durchgeführt. Forschungsleitend war die Frage, wie die Gäste dazu bewogen werden können, häufiger vegetarische oder vegane Gerichte zu wählen. Konkret wurde untersucht, wie die Gäste auf ein verändertes Menü-Angebot mit einem höheren Anteil an vegetarischen und veganen Gerichten reagieren. Das Experiment fand während 12 Wochen statt und bestand aus zwei Mensazyklen à 6 Wochen. Über den gesamten Untersuchungszeitraum werden insgesamt 90 verschiedene Gerichte angeboten. In den 6 Referenz- bzw. Basiswochen wurden zwei fleisch- oder fischhaltige Menüs und ein vegetarisches Menü angeboten. In den 6 Interventionswochen wurde das Verhältnis umgekehrt und es wurden ein veganes, ein vegetarisches und ein fleisch- oder fischhaltiges Gericht angeboten. Basis- und Interventionsangebote wechselten wöchentlich ab. Während der gesamten 12 Wochen konnten die Gäste jeweils auf ein Buffet ausweichen und ihre Mahlzeit aus warmen und kalten Komponenten selber zusammenstellen. Die Gerichte wurden über drei vorgegebene Menülinien (F, K, W) randomisiert angeboten.\n\n![Die Abbildung zeigt das Versuchsdesign der ersten 6 Experimentwochen (Kalenderwoche 40 bis 45).](figures/design_experiment.png)\n\nMehr Informationen über das Forschungsprojekt NOVANIMAL findet ihr auf der [Webpage](https://www.novanimal.ch).\n\n\n### Aufgaben\n\nFührt mit dem novanimal Datensatz (inviduelle Daten) eine logistische Regression durch, wobei ihr die einzelnen Käufer (single campus_card holder \"ccrs\") als randomisierte Variable mitberücksichtigt. Kann der Fleischkonsum durch das Geschlecht, die Hochschulzugehörigkeit und das Alter erklärt werden? Berücksichtigt auch mögliche Interaktionen zwischen dem Geschlecht und dem Alter sowie dem Geshchlecht und der Hochschulzugehörigkeit\n\n\n-   Bestimmt das minimal adäquate Modell\n-   Stellt die Ergebnisse dar\n\n\n\n::::{.content-hidden unless-meta=\"musterloesung\"}\n\n:::{.callout-note}\n\n## Musterlösung Übung 6: GLMM\n\n[Demoscript herunterladen (.R)](../purl/Statistik6_Uebung.R){.dld}\n\n[Demoscript herunterladen (.qmd)](../purl/Statistik6_Uebung.qmd){.dld}\n\n- [Lösungstext als Download](Statistik6_Loesung.pdf)\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# lade daten\nnova <- read_delim(\"datasets/stat/novanimal.csv\", delim = \";\") |>\n  mutate(across(where(is.character), as.factor))\nstr(nova)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ntibble [17,900 × 6] (S3: tbl_df/tbl/data.frame)\n $ ccrs       : num [1:17900] 1e+09 1e+09 1e+09 1e+09 1e+09 ...\n $ meat       : num [1:17900] 1 0 1 0 0 0 0 0 0 0 ...\n $ gender     : Factor w/ 2 levels \"F\",\"M\": 2 2 2 2 2 2 2 2 2 2 ...\n $ member     : Factor w/ 2 levels \"Mitarbeitende\",..: 1 1 1 1 1 1 1 1 1 1 ...\n $ age_group  : Factor w/ 4 levels \"AK1\",\"AK2\",\"AK3\",..: 1 1 1 1 1 1 1 1 1 1 ...\n $ age_group_2: Factor w/ 4 levels \"15 - 25-jaehrig\",..: 1 1 1 1 1 1 1 1 1 1 ...\n```\n\n\n:::\n\n```{.r .cell-code}\n# Die Variable“ccrs” (single campus_card holder) sollte ein facor sein\nnova$ccrs <- as.factor(nova$ccrs)\nsummary(nova)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         ccrs            meat        gender              member      age_group \n 1000564796:   57   Min.   :0.0000   F: 5863   Mitarbeitende: 6868   AK1:7651  \n 1000621354:   57   1st Qu.:0.0000   M:12037   Studierende  :11032   AK2:5720  \n 1000594415:   54   Median :1.0000                                   AK3:3104  \n 1000597794:   54   Mean   :0.6041                                   AK4:1425  \n 1000608246:   54   3rd Qu.:1.0000                                             \n 1000621447:   54   Max.   :1.0000                                             \n (Other)   :17570                                                              \n          age_group_2  \n 15 - 25-jaehrig:7651  \n 26 - 34-jaehrig:5720  \n 35 - 49-jaehrig:3104  \n 50 - 64-jaehrig:1425  \n                       \n                       \n                       \n```\n\n\n:::\n\n```{.r .cell-code}\n# sieht euch die Verteilung zwischen Fleisch und  kein Fleisch an,\n# beide Kategorien kommen nicht gleich häufig vor, ist aber nicht tragisch\ntable(nova$meat) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n    0     1 \n 7087 10813 \n```\n\n\n:::\n\n```{.r .cell-code}\nprop.table(table(nova$meat)) # Werte in Prozent\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n        0         1 \n0.3959218 0.6040782 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Definiert das logistische Modell mit ccrs als random intercept und\n# wendet es auf den Datensatz an\nglmm_1 <- glmmTMB(meat ~ gender + age_group + member + gender:age_group + gender:member + \n                    (1 | ccrs), \n                 family = binomial, \n                 data = nova)\n\nAnova(glmm_1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type II Wald chisquare tests)\n\nResponse: meat\n                    Chisq Df Pr(>Chisq)    \ngender           125.9903  1     <2e-16 ***\nage_group          4.3512  3     0.2260    \nmember             1.7696  1     0.1834    \ngender:age_group   0.8800  3     0.8302    \ngender:member      1.1107  1     0.2919    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(glmm_1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Family: binomial  ( logit )\nFormula:          \nmeat ~ gender + age_group + member + gender:age_group + gender:member +  \n    (1 | ccrs)\nData: nova\n\n     AIC      BIC   logLik deviance df.resid \n 21128.1  21213.8 -10553.0  21106.1    17889 \n\nRandom effects:\n\nConditional model:\n Groups Name        Variance Std.Dev.\n ccrs   (Intercept) 1.478    1.216   \nNumber of obs: 17900, groups:  ccrs, 1427\n\nConditional model:\n                           Estimate Std. Error z value Pr(>|z|)   \n(Intercept)               -0.060517   0.221841  -0.273  0.78501   \ngenderM                    0.825594   0.281970   2.928  0.00341 **\nage_groupAK2              -0.076795   0.171426  -0.448  0.65417   \nage_groupAK3              -0.023239   0.241615  -0.096  0.92338   \nage_groupAK4               0.209746   0.313142   0.670  0.50298   \nmemberStudierende         -0.336658   0.203570  -1.654  0.09817 . \ngenderM:age_groupAK2      -0.152603   0.213397  -0.715  0.47454   \ngenderM:age_groupAK3       0.002457   0.319039   0.008  0.99385   \ngenderM:age_groupAK4      -0.211615   0.410679  -0.515  0.60636   \ngenderM:memberStudierende  0.274622   0.260581   1.054  0.29194   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\n## erste Interpretation: Geschlecht (Referenzkategorie: Mann) scheint den Fleischkonsum positiv zu beeinflussen, schauen wir ob wir das Model vereinfachen können:\n\n# Model optimierung\ndrop1(glmm_1, test = \"Chi\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSingle term deletions\n\nModel:\nmeat ~ gender + age_group + member + gender:age_group + gender:member + \n    (1 | ccrs)\n                 Df   AIC     LRT Pr(>Chi)\n<none>              21128                 \ngender:age_group  3 21123 0.87972   0.8303\ngender:member     1 21127 1.11067   0.2919\n```\n\n\n:::\n\n```{.r .cell-code}\nglmm_2 <- update(glmm_1,~. -gender:age_group)\n\ndrop1(glmm_2, test = \"Chi\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSingle term deletions\n\nModel:\nmeat ~ gender + age_group + member + (1 | ccrs) + gender:member\n              Df   AIC    LRT Pr(>Chi)  \n<none>           21123                  \nage_group      3 21121 4.3315  0.22782  \ngender:member  1 21124 3.2749  0.07035 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nglmm_3 <- update(glmm_2,~. -gender:member)\n\ndrop1(glmm_3, test = \"Chi\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSingle term deletions\n\nModel:\nmeat ~ gender + age_group + member + (1 | ccrs)\n          Df   AIC     LRT Pr(>Chi)    \n<none>       21124                     \ngender     1 21245 123.112   <2e-16 ***\nage_group  3 21123   4.256   0.2351    \nmember     1 21124   1.968   0.1607    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nglmm_4 <- update(glmm_3,~. -age_group)\n\ndrop1(glmm_4, test = \"Chi\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSingle term deletions\n\nModel:\nmeat ~ gender + member + (1 | ccrs)\n       Df   AIC     LRT Pr(>Chi)    \n<none>    21123                     \ngender  1 21242 121.295   <2e-16 ***\nmember  1 21126   4.963   0.0259 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model validierung\n# Test overdisepersion\ncheck_overdispersion(glmm_4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Overdispersion test\n\n dispersion ratio = 0.976\n          p-value = 0.024\n```\n\n\n:::\n\n```{.r .cell-code}\n# der Wert ist nahe 1 daher i.o\n\nset.seed(123)\nsimulationOutput <- simulateResiduals(fittedModel = glmm_4, plot = TRUE, n = 500)\n```\n\n::: {.cell-output-display}\n![](Statistik6_Uebung_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Plot residuals vs covariates des models\nplotResiduals(simulationOutput, form = nova$gender)\n```\n\n::: {.cell-output-display}\n![](Statistik6_Uebung_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n\n```{.r .cell-code}\nplotResiduals(simulationOutput, form = nova$member)\n```\n\n::: {.cell-output-display}\n![](Statistik6_Uebung_files/figure-html/unnamed-chunk-3-3.png){width=672}\n:::\n\n```{.r .cell-code}\n# Die formalen Tests zeigen, dass es Probleme gibt. Die visuelle Inspektion zeigt jedoch, dass es überhaupt keine Probleme gibt und die Residiuen beinahe perfekt normalverteilt sind (dies zeigt, dass die Testergebnisse stark von der Anzahl der Beobachtungen (in diesem Fall viele) abhängen).\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Modelresultat\nAnova(glmm_4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type II Wald chisquare tests)\n\nResponse: meat\n          Chisq Df Pr(>Chisq)    \ngender 123.6924  1    < 2e-16 ***\nmember   4.9512  1    0.02607 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(glmm_4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Family: binomial  ( logit )\nFormula:          meat ~ gender + member + (1 | ccrs)\nData: nova\n\n     AIC      BIC   logLik deviance df.resid \n 21122.5  21153.7 -10557.3  21114.5    17896 \n\nRandom effects:\n\nConditional model:\n Groups Name        Variance Std.Dev.\n ccrs   (Intercept) 1.499    1.224   \nNumber of obs: 17900, groups:  ccrs, 1427\n\nConditional model:\n                  Estimate Std. Error z value Pr(>|z|)    \n(Intercept)       -0.15918    0.08504  -1.872   0.0612 .  \ngenderM            0.93860    0.08439  11.122   <2e-16 ***\nmemberStudierende -0.19512    0.08769  -2.225   0.0261 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\n# Pseudo R^2\nr2(glmm_1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# R2 for Mixed Models\n\n  Conditional R2: 0.338\n     Marginal R2: 0.040\n```\n\n\n:::\n\n```{.r .cell-code}\n# das marginale R^2 (r2m) gibt uns die erklärte Varianz der fixen Effekte: hier 4% (das ist sehr wenig)\n# das conditionale R^2 (r2c) gibt uns die erklärte Varianz für das ganze Modell\n# (mit fixen und variablen Effekten): hier 34% \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Odds Ratios\n\n# Extrahiere Estimates\nestimates <- fixef(glmm_4)\n\n# Berechne Odds Ratios\nodsr <- rbind( \n  \"Mitarbeiterinnen\" = exp( estimates$cond[\"(Intercept)\"] ), \n  \"Mitarbeiter\" = exp( estimates$cond[\"(Intercept)\"] + estimates$cond[\"genderM\"]),\n  \"Studentinnen\" =  exp( estimates$cond[\"(Intercept)\"] + estimates$cond[\"memberStudierende\"]),\n  \"Studenten\" = exp( estimates$cond[\"(Intercept)\"] + estimates$cond[\"genderM\"] + estimates$cond[\"memberStudierende\"])\n                 )\ncolnames(odsr) <- c(\"Odds_ratios\")\nodsr <- as.data.frame(odsr)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Wahrscheinlichkeiten in %\nodsr$Wahrscheinlichkeit <- ( odsr$Odds_ratios / (odsr$Odds_ratios + 1 ) )\nodsr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                 Odds_ratios Wahrscheinlichkeit\nMitarbeiterinnen    0.852846          0.4602897\nMitarbeiter         2.180207          0.6855550\nStudentinnen        0.701665          0.4123403\nStudenten           1.793729          0.6420555\n```\n\n\n:::\n\n```{.r .cell-code}\n# oder\np_load(\"ggeffects\")\npredict_response(glmm_4, c(\"member\", \"gender\") )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Predicted probabilities of meat\n\ngender: F\n\nmember        | Predicted |     95% CI\n--------------------------------------\nMitarbeitende |      0.46 | 0.42, 0.50\nStudierende   |      0.41 | 0.38, 0.45\n\ngender: M\n\nmember        | Predicted |     95% CI\n--------------------------------------\nMitarbeitende |      0.69 | 0.65, 0.72\nStudierende   |      0.64 | 0.61, 0.67\n\nAdjusted for:\n* ccrs = NA (population-level)\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualisierung\np_load(\"sjPlot\")\nplot_model(glmm_4, \n           type = \"pred\", pred.type = \"re\", \n           terms = c(\"member\", \"gender\")) +\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![](Statistik6_Uebung_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n:::\n:::: ",
    "supporting": [
      "Statistik6_Uebung_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}