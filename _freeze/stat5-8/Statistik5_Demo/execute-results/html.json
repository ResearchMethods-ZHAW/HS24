{
  "hash": "76a3d5aac3f6a91d92927184f4a36fdf",
  "result": {
    "markdown": "---\ndate: 2023-11-13\nlesson: Stat5\nthema: Von linearen Modellen zu GLMMs\nindex: 1\nformat:\n  html:\n    code-tools:\n      source: true\nknitr:\n    opts_chunk:\n        collapse: false\n---\n\n\n# Stat5: Demo\n\n-   Download dieses Demoscript via \"\\</\\>Code\" (oben rechts)\n-   Datensatz *spf.csv*\n-   Datensatz *DeerEcervi.txt*\n\n## Split-plot ANOVA\n\nReaktionszeitenbeispiel aus Kapitel 14 von @logan2010\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Daten laden\nlibrary(\"readr\")\n\nspf <- read_delim(\"datasets/stat5-8/spf.csv\", \";\")\n# Daten anschauen\nhead(spf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 4\n  Signal    VP    Messung Reaktion\n  <chr>     <chr> <chr>      <dbl>\n1 akustisch VP1   H1             3\n2 akustisch VP1   H2             4\n3 akustisch VP1   H3             7\n4 akustisch VP1   H4             7\n5 akustisch VP2   H1             6\n6 akustisch VP2   H2             5\n```\n:::\n\n```{.r .cell-code}\n# LM mit random intercept = einfaches LMM\nspf.aov <- aov(Reaktion ~ Signal * Messung + Error(VP), data = spf)\nsummary(spf.aov)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: VP\n          Df Sum Sq Mean Sq F value Pr(>F)\nSignal     1  3.125   3.125       2  0.207\nResiduals  6  9.375   1.562               \n\nError: Within\n               Df Sum Sq Mean Sq F value   Pr(>F)    \nMessung         3 194.50   64.83  127.89 2.52e-12 ***\nSignal:Messung  3  19.37    6.46   12.74 0.000105 ***\nResiduals      18   9.13    0.51                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\n# Interaktion anschauen\ninteraction.plot(spf$Messung, spf$Signal, spf$Reaktion)\n\n# Nun als LMM\nlibrary(\"nlme\")\n```\n\n::: {.cell-output-display}\n![](Statistik5_Demo_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Mit random intercept (VP) und random slope (Messung)\nspf.lme.1 <- lme(Reaktion ~ Signal * Messung, random = ~ Messung | VP, data = spf)\n# Nur random intercept\nspf.lme.2 <- lme(Reaktion ~ Signal * Messung, random = ~ 1 | VP, data = spf)\n# Modelle anschauen\nanova(spf.lme.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               numDF denDF   F-value p-value\n(Intercept)        1    18 1488.1631  <.0001\nSignal             1     6    2.0808  0.1993\nMessung            3    18   70.7887  <.0001\nSignal:Messung     3    18   11.8592  0.0002\n```\n:::\n\n```{.r .cell-code}\nanova(spf.lme.2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               numDF denDF  F-value p-value\n(Intercept)        1    18 591.6800  <.0001\nSignal             1     6   2.0000  0.2070\nMessung            3    18 127.8904  <.0001\nSignal:Messung     3    18  12.7397  0.0001\n```\n:::\n\n```{.r .cell-code}\nsummary(spf.lme.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed-effects model fit by REML\n  Data: spf \n       AIC      BIC    logLik\n  97.63924 120.0223 -29.81962\n\nRandom effects:\n Formula: ~Messung | VP\n Structure: General positive-definite, Log-Cholesky parametrization\n            StdDev    Corr                \n(Intercept) 1.0801385 (Intr) MssnH2 MssnH3\nMessungH2   0.6455527 -0.717              \nMessungH3   0.6455528 -0.837  0.600       \nMessungH4   1.3229024 -0.816  0.390  0.878\nResidual    0.2886126                     \n\nFixed effects:  Reaktion ~ Signal * Messung \n                        Value Std.Error DF   t-value p-value\n(Intercept)              3.75 0.5590162 18  6.708213  0.0000\nSignalvisuell           -2.00 0.7905683  6 -2.529826  0.0447\nMessungH2                0.25 0.3818811 18  0.654654  0.5210\nMessungH3                3.25 0.3818811 18  8.510501  0.0000\nMessungH4                4.25 0.6922184 18  6.139681  0.0000\nSignalvisuell:MessungH2  1.00 0.5400614 18  1.851641  0.0806\nSignalvisuell:MessungH3  0.50 0.5400615 18  0.925821  0.3668\nSignalvisuell:MessungH4  4.00 0.9789446 18  4.086033  0.0007\n Correlation: \n                        (Intr) Sgnlvs MssnH2 MssnH3 MssnH4 Sg:MH2 Sg:MH3\nSignalvisuell           -0.707                                          \nMessungH2               -0.683  0.483                                   \nMessungH3               -0.781  0.552  0.571                            \nMessungH4               -0.808  0.571  0.394  0.788                     \nSignalvisuell:MessungH2  0.483 -0.683 -0.707 -0.404 -0.279              \nSignalvisuell:MessungH3  0.552 -0.781 -0.404 -0.707 -0.557  0.571       \nSignalvisuell:MessungH4  0.571 -0.808 -0.279 -0.557 -0.707  0.394  0.788\n\nStandardized Within-Group Residuals:\n        Min          Q1         Med          Q3         Max \n-0.86583578 -0.26649517 -0.03263197  0.23603775  0.95285749 \n\nNumber of Observations: 32\nNumber of Groups: 8 \n```\n:::\n\n```{.r .cell-code}\nsummary(spf.lme.2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed-effects model fit by REML\n  Data: spf \n       AIC      BIC    logLik\n  89.64876 101.4293 -34.82438\n\nRandom effects:\n Formula: ~1 | VP\n        (Intercept)  Residual\nStdDev:   0.5137012 0.7120003\n\nFixed effects:  Reaktion ~ Signal * Messung \n                        Value Std.Error DF   t-value p-value\n(Intercept)              3.75 0.4389856 18  8.542422  0.0000\nSignalvisuell           -2.00 0.6208194  6 -3.221549  0.0181\nMessungH2                0.25 0.5034602 18  0.496564  0.6255\nMessungH3                3.25 0.5034602 18  6.455326  0.0000\nMessungH4                4.25 0.5034602 18  8.441580  0.0000\nSignalvisuell:MessungH2  1.00 0.7120003 18  1.404494  0.1772\nSignalvisuell:MessungH3  0.50 0.7120003 18  0.702247  0.4915\nSignalvisuell:MessungH4  4.00 0.7120003 18  5.617975  0.0000\n Correlation: \n                        (Intr) Sgnlvs MssnH2 MssnH3 MssnH4 Sg:MH2 Sg:MH3\nSignalvisuell           -0.707                                          \nMessungH2               -0.573  0.405                                   \nMessungH3               -0.573  0.405  0.500                            \nMessungH4               -0.573  0.405  0.500  0.500                     \nSignalvisuell:MessungH2  0.405 -0.573 -0.707 -0.354 -0.354              \nSignalvisuell:MessungH3  0.405 -0.573 -0.354 -0.707 -0.354  0.500       \nSignalvisuell:MessungH4  0.405 -0.573 -0.354 -0.354 -0.707  0.500  0.500\n\nStandardized Within-Group Residuals:\n        Min          Q1         Med          Q3         Max \n-1.34519292 -0.63943480 -0.06164167  0.41510594  2.15199656 \n\nNumber of Observations: 32\nNumber of Groups: 8 \n```\n:::\n:::\n\n\n## GLMM\n\n-\\> Hirschparasitenbeispiel aus Kapitel 13 von @zuur2009\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Daten laden und für GLMM aufbereiten\nDeerEcervi <- read_delim(\"datasets/stat5-8/DeerEcervi.txt\", \"\\t\",  col_types = cols(\"Farm\" = \"f\"))\n# Daten anschauen\nhead(DeerEcervi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 4\n  Farm    Sex Length Ecervi\n  <fct> <dbl>  <dbl>  <dbl>\n1 AL        2    164    0  \n2 AL        1    216    0  \n3 AL        1    208    0  \n4 AL        1    206   14.4\n5 AL        1    204    0  \n6 AL        1    200    0  \n```\n:::\n\n```{.r .cell-code}\nsummary(DeerEcervi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      Farm          Sex            Length          Ecervi       \n MO     :209   Min.   :1.000   Min.   : 75.0   Min.   :   0.00  \n CB     : 85   1st Qu.:1.000   1st Qu.:151.0   1st Qu.:   0.00  \n QM     : 60   Median :1.000   Median :163.0   Median :   6.60  \n BA     : 50   Mean   :1.458   Mean   :161.8   Mean   :  45.42  \n PN     : 37   3rd Qu.:2.000   3rd Qu.:174.9   3rd Qu.:  35.79  \n MB     : 34   Max.   :2.000   Max.   :216.0   Max.   :2186.60  \n (Other):351                                                    \n```\n:::\n\n```{.r .cell-code}\n# Anzahl Larven hier in Presence/Absence übersetzt\nDeerEcervi$Ecervi.01 <- DeerEcervi$Ecervi\nDeerEcervi$Ecervi.01[DeerEcervi$Ecervi > 0] <- 1\n# Numerische Geschlechtscodierung als Factor\nDeerEcervi$fSex <- as.factor(DeerEcervi$Sex)\n# Hischlänge standardisieren\nDeerEcervi$CLength <- DeerEcervi$Length - mean(DeerEcervi$Length)\n```\n:::\n\n\n-\\> Nun sind die Daten bereit:\n\n-   Die Parasitenbefalldaten wurden in Parasiten Präsenz/Absenz (1/0) übersetzt.\n-   Die Hirschlänge wurde standardisiert, damit der Achsenabschnitt (intercept) des Modells interpretierbar ist, standardisierte entspricht nun der Achsenabschnitt einem durschnittlich langen Hirsch.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Zunächst als GLM\n# Interaktionen mit fFarm nicht berücksichtigt, da zu viele Freiheitsgrade verbraucht würden\nDE.glm <- glm(Ecervi.01 ~ CLength * fSex + Farm, family = binomial, data = DeerEcervi)\n\ndrop1(DE.glm, test = \"Chi\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSingle term deletions\n\nModel:\nEcervi.01 ~ CLength * fSex + Farm\n             Df Deviance     AIC     LRT  Pr(>Chi)    \n<none>            745.50  799.50                      \nFarm         23  1003.72 1011.72 258.225 < 2.2e-16 ***\nCLength:fSex  1   755.48  807.48   9.984  0.001579 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\nsummary(DE.glm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = Ecervi.01 ~ CLength * fSex + Farm, family = binomial, \n    data = DeerEcervi)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.8400  -0.7576   0.3556   0.6431   2.2964  \n\nCoefficients:\n                Estimate Std. Error z value Pr(>|z|)    \n(Intercept)   -1.796e+00  5.900e-01  -3.044 0.002336 ** \nCLength        4.062e-02  7.132e-03   5.695 1.24e-08 ***\nfSex2          6.280e-01  2.292e-01   2.740 0.006150 ** \nFarmAU         3.340e+00  7.841e-01   4.259 2.05e-05 ***\nFarmBA         3.510e+00  7.150e-01   4.908 9.19e-07 ***\nFarmBE         1.883e+01  6.216e+02   0.030 0.975831    \nFarmCB         3.012e+00  6.573e-01   4.583 4.58e-06 ***\nFarmCRC       -1.293e+01  2.400e+03  -0.005 0.995701    \nFarmHB        -2.364e-01  9.730e-01  -0.243 0.808045    \nFarmLN         3.831e+00  8.881e-01   4.314 1.60e-05 ***\nFarmMAN        1.046e+00  6.960e-01   1.503 0.132855    \nFarmMB         3.693e+00  8.152e-01   4.529 5.91e-06 ***\nFarmMO         9.722e-01  5.969e-01   1.629 0.103380    \nFarmNC         1.370e+00  6.904e-01   1.985 0.047169 *  \nFarmNV         2.098e+00  7.702e-01   2.725 0.006435 ** \nFarmPN         4.185e+00  8.584e-01   4.875 1.09e-06 ***\nFarmQM         3.975e+00  7.220e-01   5.506 3.68e-08 ***\nFarmRF         4.552e+00  1.050e+00   4.337 1.45e-05 ***\nFarmRN         8.706e-01  7.454e-01   1.168 0.242822    \nFarmRO         4.555e+00  9.556e-01   4.766 1.88e-06 ***\nFarmSAU       -1.545e+01  1.368e+03  -0.011 0.990986    \nFarmSE         2.785e+00  7.876e-01   3.536 0.000407 ***\nFarmTI         3.900e+00  1.166e+00   3.343 0.000828 ***\nFarmTN         3.102e+00  7.665e-01   4.046 5.21e-05 ***\nFarmVISO       3.720e+00  1.011e+00   3.679 0.000234 ***\nFarmVY         3.974e+00  1.257e+00   3.162 0.001565 ** \nCLength:fSex2  3.618e-02  1.168e-02   3.097 0.001953 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1073.1  on 825  degrees of freedom\nResidual deviance:  745.5  on 799  degrees of freedom\nAIC: 799.5\n\nNumber of Fisher Scoring iterations: 15\n```\n:::\n\n```{.r .cell-code}\nanova(DE.glm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n\nModel: binomial, link: logit\n\nResponse: Ecervi.01\n\nTerms added sequentially (first to last)\n\n             Df Deviance Resid. Df Resid. Dev\nNULL                           825    1073.13\nCLength       1   64.815       824    1008.31\nfSex          1    0.191       823    1008.12\nFarm         23  252.638       800     755.48\nCLength:fSex  1    9.984       799     745.50\n```\n:::\n\n```{.r .cell-code}\n# Response curves für die einzelnen Farmen (Weibliche Tiere: fSex = \"1\" )\nplot(DeerEcervi$CLength, DeerEcervi$Ecervi.01,\n  xlab = \"Length\", ylab = \"Probability of \\\n     presence of E. cervi L1\"\n)\nI <- order(DeerEcervi$CLength)\nAllFarms <- unique(DeerEcervi$Farm)\nfor (j in AllFarms) {\n  mydata <- data.frame(\n    CLength = DeerEcervi$CLength, fSex = \"1\",\n    Farm = j\n  )\n  n <- dim(mydata)[1]\n  if (n > 10) {\n    P.DE2 <- predict(DE.glm, mydata, type = \"response\")\n    lines(mydata$CLength[I], P.DE2[I])\n  }\n}\n```\n\n::: {.cell-output-display}\n![](Statistik5_Demo_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# glmm\nlibrary(\"MASS\")\n\nDE.PQL <- glmmPQL(Ecervi.01 ~ CLength * fSex,\n  random = ~ 1 | Farm, family = binomial, data = DeerEcervi\n)\nsummary(DE.PQL)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed-effects model fit by maximum likelihood\n  Data: DeerEcervi \n  AIC BIC logLik\n   NA  NA     NA\n\nRandom effects:\n Formula: ~1 | Farm\n        (Intercept)  Residual\nStdDev:    1.462108 0.9620576\n\nVariance function:\n Structure: fixed weights\n Formula: ~invwt \nFixed effects:  Ecervi.01 ~ CLength * fSex \n                  Value Std.Error  DF  t-value p-value\n(Intercept)   0.8883697 0.3373283 799 2.633547  0.0086\nCLength       0.0378608 0.0065269 799 5.800768  0.0000\nfSex2         0.6104570 0.2137293 799 2.856216  0.0044\nCLength:fSex2 0.0350666 0.0108558 799 3.230228  0.0013\n Correlation: \n              (Intr) CLngth fSex2 \nCLength       -0.108              \nfSex2         -0.191  0.230       \nCLength:fSex2  0.092 -0.522  0.235\n\nStandardized Within-Group Residuals:\n       Min         Q1        Med         Q3        Max \n-6.3466592 -0.6387839  0.2978382  0.5218829  3.4912879 \n\nNumber of Observations: 826\nNumber of Groups: 24 \n```\n:::\n\n```{.r .cell-code}\nDE.PQL$coefficients[1][1]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$fixed\n  (Intercept)       CLength         fSex2 CLength:fSex2 \n   0.88836974    0.03786082    0.61045698    0.03506664 \n```\n:::\n\n```{.r .cell-code}\n# Modellvoraussagen berechnen\n# So könnte direkt auf die coefficients zugegriffen werden: DE.PQL$coefficients[[1]][1]\ng <- 0.8883697 + 0.0378608 * DeerEcervi$CLength\n# Rücktransformieren aus Logit\np.averageFarm1 <- exp(g) / (1 + exp(g))\n# Sortierung der Hirschgrössen für's Plotten\nI <- order(DeerEcervi$CLength)\n# Plotten\nplot(DeerEcervi$CLength, DeerEcervi$Ecervi.01,\n  xlab = \"Length\",\n  ylab = \"Probability of presence of E. cervi L1\"\n)\nlines(DeerEcervi$CLength[I], p.averageFarm1[I], lwd = 3)\n# Vertrauensintervalle (CI) mit SD von Random factor berechnen\n# Generell CI = mean + 1.96*SD\np.Upp <- exp(g + 1.96 * 1.462108) / (1 + exp(g + 1.96 * 1.462108))\np.Low <- exp(g - 1.96 * 1.462108) / (1 + exp(g - 1.96 * 1.462108))\nlines(DeerEcervi$CLength[I], p.Upp[I])\nlines(DeerEcervi$CLength[I], p.Low[I])\n```\n\n::: {.cell-output-display}\n![](Statistik5_Demo_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# Dasselbe mit dem lme4-Package\nlibrary(\"lme4\")\nDE.lme4 <- glmer(Ecervi.01 ~ CLength * fSex + (1 | Farm),\n  family = binomial, data = DeerEcervi\n)\nsummary(DE.lme4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nGeneralized linear mixed model fit by maximum likelihood (Laplace\n  Approximation) [glmerMod]\n Family: binomial  ( logit )\nFormula: Ecervi.01 ~ CLength * fSex + (1 | Farm)\n   Data: DeerEcervi\n\n     AIC      BIC   logLik deviance df.resid \n   832.6    856.1   -411.3    822.6      821 \n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-6.2678 -0.6090  0.2809  0.5022  3.4546 \n\nRandom effects:\n Groups Name        Variance Std.Dev.\n Farm   (Intercept) 2.391    1.546   \nNumber of obs: 826, groups:  Farm, 24\n\nFixed effects:\n              Estimate Std. Error z value Pr(>|z|)    \n(Intercept)   0.938969   0.356004   2.638  0.00835 ** \nCLength       0.038964   0.006917   5.633 1.77e-08 ***\nfSex2         0.624487   0.222938   2.801  0.00509 ** \nCLength:fSex2 0.035859   0.011409   3.143  0.00167 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n            (Intr) CLngth fSex2 \nCLength     -0.107              \nfSex2       -0.189  0.238       \nCLngth:fSx2  0.091 -0.514  0.232\n```\n:::\n\n```{.r .cell-code}\nlibrary(\"glmmML\")\nDE.glmmML <- glmmML(Ecervi.01 ~ CLength * fSex,\n  cluster = Farm, family = binomial, data = DeerEcervi\n)\nsummary(DE.glmmML)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:  glmmML(formula = Ecervi.01 ~ CLength * fSex, family = binomial,      data = DeerEcervi, cluster = Farm) \n\n                 coef se(coef)     z Pr(>|z|)\n(Intercept)   0.93968 0.357915 2.625 8.65e-03\nCLength       0.03898 0.006956 5.604 2.10e-08\nfSex2         0.62451 0.224251 2.785 5.35e-03\nCLength:fSex2 0.03586 0.011437 3.135 1.72e-03\n\nScale parameter in mixing distribution:  1.547 gaussian \nStd. Error:                              0.2975 \n\n        LR p-value for H_0: sigma = 0:  1.346e-41 \n\nResidual deviance: 822.6 on 821 degrees of freedom \tAIC: 832.6 \n```\n:::\n:::\n",
    "supporting": [
      "Statistik5_Demo_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}